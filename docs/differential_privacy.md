# Differential Privacy Analysis for Glasswally IOC Sharing

## Overview

Cross-provider IOC sharing (see `glasswally/src/ioc_feed.rs`) requires publishing
detection signals about accounts to peer LLM providers.  This raises privacy
questions: can we share useful threat intelligence without revealing information
that could be used to identify, discriminate against, or harm legitimate users
who appear in detection data?

This document provides a formal differential privacy (DP) analysis of each IOC
bundle field and makes deployment recommendations for regulated environments
(GDPR, CCPA, HIPAA BAA contexts).

---

## Privacy Model

We treat each **API account** as one individual's data record.  The IOC sharing
mechanism must satisfy (ε, δ)-DP with respect to the inclusion or exclusion of
any single account from the detection dataset.

**Target parameters** (recommended):
- ε = 1.0 — moderate privacy (standard ML publication threshold)
- δ = 10⁻⁶ — failure probability (suitable for dataset sizes up to 10⁶ accounts)

---

## Per-Field Analysis

### Fields: `ip_addresses`, `ip_subnets`

**Privacy risk**: High. IP addresses are quasi-identifiers — combined with timestamps
they can uniquely identify individuals in many jurisdictions (CJEU ruling, 2016).

**DP treatment**:
- **Generalize**: Publish /24 subnet rather than specific IP address
- **Suppress**: Do not publish IPs from ranges with < k accounts (k = 5, k-anonymity)
- **Noise**: Apply Laplace noise to subnet occurrence counts: count + Lap(1/ε)

**Deployment**: Only publish /24 subnets with ≥5 accounts from that subnet in the
campaign cluster.  Suppress IPs from residential /24 ranges (ASN = residential ISP).

---

### Fields: `payment_hashes`

**Privacy risk**: Medium-High. Payment method hashes are derived from card numbers
or account identifiers. Even hashed, they may be linkable across providers if the
original payment method is known.

**DP treatment**:
- Only include in IOC bundle if ≥3 distinct accounts share the same BIN prefix
- Apply group privacy (k-anonymity): suppress any single-account payment hash
- Do not include payment hashes from accounts with < 5 total requests (may be legitimate)

**Deployment**: Publish only BIN prefix group indicators (e.g., "3 accounts in cluster share BIN prefix 4532xx"), not individual payment hashes.

---

### Fields: `ja3_hashes`, `ja3s_hashes`, `h2_fingerprints`

**Privacy risk**: Low. TLS and HTTP/2 fingerprints are behavioral characteristics of
software libraries, not individuals. Many accounts share the same fingerprint (e.g.,
all python-httpx users share the same JA3).

**DP treatment**: None required. Fingerprints are public (published in library source code).

**Deployment**: Publish freely.

---

### Fields: `account_ids`

**Privacy risk**: Very High. Direct account identifiers.

**DP treatment**:
- **Never** publish raw account IDs in cross-provider IOC feeds
- Publish only: `"n_accounts": 47` (count with Laplace noise)
- For internal use only: hashed account IDs with provider-specific salt

**GDPR note**: Under GDPR Article 4, pseudonymized account IDs are still personal data
if re-identification is possible.  Cross-provider sharing of hashed IDs requires a
Data Processing Agreement (DPA) and legitimate interest assessment (LIA).

---

### Fields: `watermark_tokens`, `canary_token`

**Privacy risk**: Low. These are opaque tokens generated by Glasswally — they carry no
personal information themselves.

**DP treatment**: None required.  However, a triggered canary token indirectly reveals
that an account engaged in distillation — this is behavioral data, not personal data.

**Deployment**: Publish freely (tokens are meaningless without the account-to-token
mapping held only by the issuing provider).

---

### Fields: `country_codes`

**Privacy risk**: Low. Country-level aggregation is generally considered non-identifying.

**DP treatment**: Apply k-anonymity (only include countries with ≥5 accounts in cluster).

---

## Recommended IOC Bundle Privacy Profile

For cross-provider sharing in regulated environments, apply the following filters
before calling `IocFeedPublisher::submit()`:

```rust
// Privacy-safe IOC bundle construction
let safe_bundle = IocBundle {
    ip_subnets: subnets_with_k_accounts(&raw_bundle.ip_subnets, 5),  // /24 only, k≥5
    ip_addresses: vec![],    // never publish individual IPs externally
    ja3_hashes: raw_bundle.ja3_hashes.clone(),       // safe
    ja3s_hashes: raw_bundle.ja3s_hashes.clone(),     // safe
    h2_fingerprints: raw_bundle.h2_fingerprints.clone(), // safe
    payment_hashes: vec![],  // never publish externally; use BIN prefix counts in evidence
    watermark_tokens: raw_bundle.watermark_tokens.clone(), // safe
    account_ids: vec![],     // never publish externally
    country_codes: countries_with_k_accounts(&raw_bundle.country_codes, 5),
    // Add Laplace noise to counts
    total_requests: noisy_count(raw_bundle.total_requests, 1.0 / 1.0), // ε=1
    confidence: raw_bundle.confidence,
    ..raw_bundle
};
```

---

## Regulatory Compliance Matrix

| Regulation | Key Requirement | Glasswally Compliance |
|-----------|-----------------|----------------------|
| **GDPR (EU)** | Lawful basis for processing; data minimisation; pseudonymisation | Legitimate interest (fraud prevention); minimal field export; account IDs not shared |
| **CCPA (California)** | Right to opt-out of "sale" of personal information | IOC sharing is not a sale; provider DPA establishes controller relationship |
| **PIPEDA (Canada)** | Consent or legitimate purpose | Fraud/abuse prevention is a recognized legitimate purpose |
| **LGPD (Brazil)** | Similar to GDPR; DPA required | Requires bilateral DPA between providers |
| **PDPA (Thailand/Singapore)** | Data localisation concerns | IOC bundles should not leave jurisdiction without DPA |
| **HIPAA** | Not directly applicable (not health data) | N/A unless AI is used in healthcare context |

---

## Formal DP Guarantee Statement

With the privacy-safe bundle construction above, Glasswally's IOC sharing satisfies:

- **(k=5)-anonymity**: No individual account can be distinguished from at least 4 others in any published field
- **(ε=1, δ=10⁻⁶)-differential privacy** on count fields (Laplace mechanism, sensitivity=1)
- **Group privacy** on payment fields: only group-level indicators (BIN prefix counts) published

These guarantees hold under the assumption that the verifying provider's key is secret
and that raw account IDs are never logged by either provider during IOC exchange.
